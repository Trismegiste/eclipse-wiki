{% extends "base.html.twig" %}

{% form_theme form _self %}

{% block _npc_stats_edges_widget %}
    <div>
        <template x-for="(edge, idx) in edges" :key="edge.name">
            <div class="pure-g">
                <div class="pure-u-1-3"><label x-text="edge.name"></label></div>
                <div class="pure-u-1-3">
                    <input x-bind:name="'npc_stats[edges][' + idx + '][name]'" type="hidden" required="required" x-model="edge.name"/>
                    <select x-bind:name="'npc_stats[edges][' + idx + '][origin]'" required="required" x-model="edge.origin">
                        <option value="Progression">Progression</option>
                        <option value="Background">Background</option>
                        <option value="Faction">Faction</option>
                        <option value="Création">Création</option>
                        <option value="Morphe">Morphe</option>
                        <option value="Slot">Slot</option>
                            <option value="Cadeau">Cadeau</option>
                    </select>
                </div>
                <nav class="pure-u-1-3">
                    <a href="#"><i class="icon-angle-circled-up"></i></a>
                    <a href="#"><i class="icon-angle-circled-down"></i></a>
                    <a href="#"><i class="icon-trash-empty"></i></a>
                </nav>
            </div>
        </template>
    </div>
{% endblock %}

{% block content %}
    {{ form(form, {attr: {'x-data': form.vars.data|json_encode()}}) }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="//unpkg.com/alpinejs" defer></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {

            // link checkbox to listing
            [...document.querySelectorAll('#npc_stats_skill_list input[type=checkbox]')].forEach(function (item) {

                // check the checkbox if the same skill in the listing
                if (document.querySelector('#npc_stats_skills input[type=hidden][value="' + item.value + '"]') !== null) {
                    item.checked = true
                }

                // Add event listener on checkbox
                item.addEventListener('change', function (ev) {

                    const key = ev.target.id.match(/.+_(\d+)$/)[1]
                    const skillName = ev.target.value

                    if (ev.target.checked) {
                        // Append skill
                        const collectionHolder = document.querySelector('#npc_stats_skills')

                        collectionHolder.innerHTML += collectionHolder
                                .dataset
                                .prototype
                                .replace(/__name__/g, Math.floor(100 + 1000000 * Math.random()))
                                .replace(/__undefined__/g, skillName)
                    } else {
                        // Delete skill
                        document.querySelector('#npc_stats_skills input[type=hidden][value="' + skillName + '"]').parentNode.parentNode.remove()
                    }
                })
            })
        })
    </script>
{% endblock %}