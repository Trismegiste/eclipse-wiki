{# Player peering #}
{% extends "base.html.twig" %}

{% block title %}Appairage Joueur{% endblock %}

{% block body %}
    <h1 class="big-title">{{ block('title') }}</h1>
    <div x-data="peering('{{ mercure('peering') }}', '{{ path('app_playerlog_hello') }}', '{{ path('app_playerlog_index') }}')" class="peering">
        <h2>Bienvenue sur Eclipse-Wiki</h2>
        <h2>la webapp de VTTRPG</h2>
        <p>Ma clef d'appairage est</p>
        <p x-text="peeringKey" class="big"/>
    </div>
{% endblock %}

{% block javascripts %}
    {# parent() #}
    <script type="module">
        Alpine.data('peering', (mercureHost, helloUrl, playerLogUrl) => ({
                host: mercureHost,
                socket: null,
                helloUrl: helloUrl,
                peeringKey: null,

                init() {
                    // Before everything, check if the client was previously authenticated
                    if (this.getCurrentCharacterTitle()) {
                        window.location = playerLogUrl
                    }

                    // peering key
                    this.peeringKey = 1000 + Math.floor(Math.random() * 9000);
                    // SSE Socket
                    this.socket = new EventSource(this.host)
                    // listen to feeback from the GM
                    this.socket.addEventListener('validation', (msg) => {
                        console.log('Validation from GM')
                        const content = JSON.parse(msg.data)
                        if (content.identifier === this.peeringKey) {
                            console.log('Client authentifié en tant que ' + content.characterTitle)
                            this.setCurrentCharacterTitle(content.characterTitle)
                            window.location = playerLogUrl
                        }
                    })

                    // « Hello I'm here and I want to peer with this ID »
                    fetch(helloUrl, {
                        method: 'POST',
                        body: JSON.stringify({identifier: this.peeringKey})
                    })
                            .then(resp => {
                                return resp.json()
                            })
                            .then(data => {
                                console.log(data)
                            })
                },

                getCurrentCharacterTitle() {
                    return localStorage.getItem('characterTitle')
                },

                setCurrentCharacterTitle(title) {
                    localStorage.setItem('characterTitle', title)
                }
            }))
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .peering {
            text-align: center;
        }
        .peering .big {
            font-size: 400%;
        }
    </style>
{% endblock %}
