{# Player peering #}
{% extends "base.html.twig" %}

{% block title %}Appairage Joueur{% endblock %}

{% block body %}
    <div x-data="peering('{{ mercure('peering') }}', '{{ path('app_playerlog_hello') }}', '{{ path('app_playerlog_index') }}')">
        Ma clef est <span x-text="peeringKey"/>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module">
        Alpine.data('peering', (mercureHost, helloUrl, playerLogUrl) => ({
                host: mercureHost,
                socket: null,
                helloUrl: helloUrl,
                peeringKey: null,

                init() {
                    // Before everything, check if the client was previously authenticated
                    if (localStorage.getItem('npcTitle')) {
                        window.location = playerLogUrl
                    }

                    // peering key
                    this.peeringKey = Math.floor(Math.random() * 10000);
                    // SSE Socket
                    this.socket = new EventSource(this.host)
                    // listen to feeback from the GM
                    this.socket.addEventListener('validation', (msg) => {
                        console.log('Validation from GM')
                        const content = JSON.parse(msg.data)
                        if (content.identifier === this.peeringKey) {
                            console.log('Client authentifié en tant que ' + content.npcTitle)
                            localStorage.setItem('npcTitle', content.npcTitle)
                            window.location = playerLogUrl
                        }
                    })

                    // « Hello I'm here and I want to peer with this ID »
                    fetch(helloUrl, {
                        method: 'POST',
                        body: JSON.stringify({identifier: this.peeringKey})
                    })
                            .then(resp => {
                                return resp.json()
                            })
                            .then(data => {
                                console.log(data)
                            })
                }
            }))
    </script>
{% endblock %}
