{% extends "base.html.twig" %}

{% block content %}
    <canvas id="renderCanvas"></canvas>
    {% endblock %}

{% block javascripts %}
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="{{ asset('js/battlemap-loader.js') }}"></script>
    <script>
        const canvas = document.getElementById("renderCanvas") // Get the canvas element
        const engine = new BABYLON.Engine(canvas) // Generate the BABYLON 3D engine
        const wallHeight = 1.5

        const createScene = function () {
            // Creates a basic Babylon Scene object
            const scene = new BABYLON.Scene(engine)
            // Set gravity for the scene (G force like, on Y-axis)
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            // Enable Collisions
            scene.collisionsEnabled = true;

            // Creates and positions a free camera
            var camera = new BABYLON.UniversalCamera("player-camera", new BABYLON.Vector3(0, 2 * wallHeight / 3, 0), scene);
            camera.setTarget(new BABYLON.Vector3(0, wallHeight, -10));
            camera.attachControl(canvas)
            camera.minZ = 0.01;
            camera.fov = 60 / 180 * Math.PI
            // Then apply collisions and gravity to the active camera
            camera.checkCollisions = true;
            camera.applyGravity = true;
            //Set the ellipsoid around the camera (e.g. your player's size)
            camera.ellipsoid = new BABYLON.Vector3(0.1, wallHeight / 3, 0.1);

            // Creates a light, aiming 0,1,0 - to the sky
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene)
            // Dim the light a small amount - 0 to 1
            light.intensity = 0.9

            // Templates
            let textureKey = ['default', 'cluster-sleep', 'cluster-industry', 'cluster-park']
            // Ground templates
            textureKey.forEach((key) => {
                const tile = BABYLON.MeshBuilder.CreateDisc("hexagon-" + key, {tessellation: 6, radius: 2 / 3 - 0.01}, scene)
                tile.rotation.z = Math.PI / 6
                tile.rotation.x = Math.PI / 2
                tile.isVisible = false

                const myMaterial = new BABYLON.StandardMaterial('mat-ground-' + key, scene)
                myMaterial.diffuseTexture = new BABYLON.Texture("/texture/habitat/ground/" + key + ".webp", scene)
                tile.material = myMaterial
            })

            // selector
            const groundSelector = BABYLON.MeshBuilder.CreateDisc("selector-ground", {tessellation: 6, radius: 2 / 3}, scene)
            groundSelector.rotation.z = Math.PI / 6
            groundSelector.rotation.x = Math.PI / 2
            groundSelector.position.y = 0.01
            groundSelector.isVisible = false
            const selectorMat = new BABYLON.StandardMaterial('mat-selector')
            selectorMat.diffuseColor = new BABYLON.Color3(1, 0, 0)
            selectorMat.alpha = 0.5
            groundSelector.material = selectorMat
            groundSelector.actionManager = new BABYLON.ActionManager(scene);
            groundSelector.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, (e) => {
                        const camera = scene.getCameraByName('player-camera')
                        const target = e.meshUnderPointer.position.clone()
                        target.y = camera.position.y

                        const frameRate = 10
                        const moving = new BABYLON.Animation("moving", "position", frameRate, BABYLON.Animation.ANIMATIONTYPE_VECTOR3)
                        moving.setKeys([
                            {frame: 0, value: camera.position},
                            {frame: frameRate, value: target}
                        ])
                        camera.animations.push(moving)
                        scene.beginAnimation(camera, 0, frameRate)
                    })
                    )

            // Wall templates
            textureKey.forEach((key) => {
                const wall = BABYLON.MeshBuilder.CreatePlane("wall-" + key, {width: 2 / 3, height: wallHeight})
                wall.position.y = wallHeight / 2
                wall.position.x = 2 / 3 * Math.cos(Math.PI / 6)
                wall.rotation.y = Math.PI / 2
                wall.isVisible = false

                const myMaterial = new BABYLON.StandardMaterial('mat-wall-' + key, scene)
                myMaterial.diffuseTexture = new BABYLON.Texture("/texture/habitat/wall/" + key + ".webp", scene)
                wall.material = myMaterial
            })

            // Generic door
            const door = BABYLON.MeshBuilder.CreatePlane('door', {width: 2 / 3, height: wallHeight})
            door.position.y = wallHeight / 2
            door.position.x = 2 / 3 * Math.cos(Math.PI / 6)
            door.rotation.y = Math.PI / 2
            door.isVisible = false

            const doorMat = new BABYLON.StandardMaterial('mat-door', scene)
            doorMat.diffuseTexture = new BABYLON.Texture("/texture/habitat/door.webp", scene)
            door.material = doorMat

            return scene
        }

        BABYLON.SceneLoader.RegisterPlugin(battlemapLoader)

        const scene = createScene() //Call the createScene function
        BABYLON.SceneLoader.Append("/voronoi/babylon/", "{{ place.pk }}.battlemap", scene, function (scene) {})

        // Register a render loop to repeatedly render the scene
        engine.runRenderLoop(function () {
            scene.render()
        })
        // Watch for browser/canvas resize events
        window.addEventListener("resize", function () {
            engine.resize()
        })
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
{% endblock %}
