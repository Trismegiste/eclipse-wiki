{% extends "base.html.twig" %}

{% block content %}
    <canvas id="renderCanvas"></canvas>
    {% endblock %}

{% block javascripts %}
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script>
        const canvas = document.getElementById("renderCanvas") // Get the canvas element
        const engine = new BABYLON.Engine(canvas, true) // Generate the BABYLON 3D engine

        const createScene = function () {
            // Creates a basic Babylon Scene object
            const scene = new BABYLON.Scene(engine)
            // Set gravity for the scene (G force like, on Y-axis)
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);

            // Creates and positions a free camera
            var camera = new BABYLON.FreeCamera("FreeCamera", new BABYLON.Vector3(0, 2, 0), scene);
            camera.setTarget(new BABYLON.Vector3(1, 2, -1));
            camera.attachControl(canvas, true);
            camera.minZ = 0.45;

            // Enable Collisions
            scene.collisionsEnabled = true;

            // Then apply collisions and gravity to the active camera
            camera.checkCollisions = true;
            camera.applyGravity = true;

            //Set the ellipsoid around the camera (e.g. your player's size)
            camera.ellipsoid = new BABYLON.Vector3(0.4, 0.4, 0.4);

            // Creates a light, aiming 0,1,0 - to the sky
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene)
            // Dim the light a small amount - 0 to 1
            light.intensity = 0.9

            return scene
        }
        const scene = createScene() //Call the createScene function


        BABYLON.SceneLoader.RegisterPlugin({
            extensions: ".battlemap",
            importMesh: function (meshesNames, scene, data, rootUrl, meshes, particleSystems, skeletons) {
                return true
            },
            load: function (scene, data, rootUrl) {

                let textureKey = ['default', 'cluster-sleep', 'cluster-industry']
                let template = {}
                textureKey.forEach((key) => {
                    const tile = BABYLON.MeshBuilder.CreateDisc("hexagon-" + key, {tessellation: 6, radius: 2 / 3 - 0.01}, scene)
                    tile.rotation.z = Math.PI / 6
                    tile.rotation.x = Math.PI / 2
                    tile.isVisible = false
                    const myMaterial = new BABYLON.StandardMaterial('mat-' + key, scene)
                    myMaterial.diffuseTexture = new BABYLON.Texture("/texture/habitat/ground/" + key + ".webp", scene)
                    tile.material = myMaterial
                    template[key] = tile
                })

                const wall = BABYLON.Mesh.CreatePlane("wall", 2 / 3)
                wall.position.y = 1 / 3
                wall.position.x = 2 / 3 * Math.cos(Math.PI / 6)
                wall.rotation.y = Math.PI / 2
                wall.isVisible = false

                const origin = BABYLON.MeshBuilder.CreateSphere('origin', {diameter: 0.1})

                const battlemap = JSON.parse(data)
                battlemap.grid.forEach((cell, k) => {
                    const ground = template[cell.obj.template].createInstance("ground" + k)
                    ground.position.x = cell.x
                    ground.position.z = -cell.y
                    ground.checkCollisions = true

                    for (let dir = 0; dir < 6; dir++) {
                        if (cell.obj.wall[dir]) {
                            const handle = new BABYLON.TransformNode("handle" + k + '-' + dir)
                            const tmpWall = wall.createInstance("wall-" + k + '-' + dir)
                            tmpWall.parent = handle
                            handle.rotation.y = -dir * Math.PI / 3
                            handle.position.x = cell.x
                            handle.position.z = -cell.y
                        }
                    }
                })

                return true
            },
            loadAssets(scene, data, rootUrl) {
                var container = new AssetContainer(scene)
                return container
            }
        })

        BABYLON.SceneLoader.Append("/voronoi/babylon/", "{{ place.pk }}.battlemap", scene, function (scene) {})

        // Register a render loop to repeatedly render the scene
        engine.runRenderLoop(function () {
            scene.render()
        })
        // Watch for browser/canvas resize events
        window.addEventListener("resize", function () {
            engine.resize()
        })
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
{% endblock %}
