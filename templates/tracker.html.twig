{% extends "base.html.twig" %}

{% block content %}
    <div x-data="behavior" class="pure-g">
        <section class="pure-u-1-2">
            <ul>
                {% for npc in listing %}
                    <li>
                        <a x-on:click="push('{{ npc.title }}',{{ npc.wildCard ? 'true' : 'false' }},{{ npc.parry }},{{ npc.rangedMalus }},{{ npc.toughness }},{{ npc.totalArmor }})">{{ npc.title }}</a>
                    </li>
                {% endfor %}
            </ul>
        </section>
        <section class="pure-u-1-6">
            <ul>
                <template x-for="npc in encounter">
                    <li x-text="npc.name"></li>
                </template>
            </ul>
        </section>
        <canvas x-ref="qrious" class="pure-u-1-3"></canvas>
    </div>     
    {% if app.debug %}
        <div><p><a href="#" x-ref="link">Local test</a></p></div>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('neocotic/qrious.min.js') }}"></script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('behavior', () => ({
                    encounter: [],
                    qrCode: null,
                    init() {
                        this.qrCode = new QRious({
                            element: this.$refs.qrious,
                            size: Math.min(innerWidth, innerHeight),
                            value: '-Vide-'
                        })
                    },
                    push(name, wc, par, rgm, tough, arm) {
                        this.encounter.push({name: name, w: wc, p: par, r: rgm, t: tough, a: arm})
                        let param = new URLSearchParams()
                        for (const npc of this.encounter) {
                            param.append('name', npc.name)
                            param.append('w', npc.w)
                            param.append('p', npc.p)
                            param.append('r', npc.r)
                            param.append('t', npc.t)
                            param.append('a', npc.a)
                        }

                        this.qrCode.value = 'https://trismegiste.github.io/eclipse-wiki/public/initiative.html?'
                                + param.toString()
                        this.$refs.link.href = 'http://localhost:8000/initiative.html?' + param.toString()
                    }
                }))
        })
    </script>
{% endblock %}