{% extends 'form.html.twig' %}

{% block content %}
    <section>
        {{ parent() }}
    </section>
    <section x-data="llm">
        <div x-show="waiting" style="text-align: center"><i class="icon-spin3 animate-spin big-waiting"></i></div>
        <div class="pure-form" x-show="content !== ''">
            <fieldset>
                <textarea x-model="content" class="pure-input-1" rows="35"></textarea>
            </fieldset>
        </div>
    </section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="application/json" id="ollama-payload">
        {{ payload|json_encode()|raw }}
    </script>
    <script type="module">
        Alpine.data('llm', () => ({
                content: '',
                reader: null,
                decoder: null,
                waiting: false,

                async init() {
                    this.decoder = new TextDecoder()

                    const payload = JSON.parse(document.getElementById('ollama-payload').textContent)
                    if (payload === null) {
                        return;
                    }

                    this.waiting = true

                    const resp = await fetch('http://localhost:11434/api/chat', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    })

                    this.reader = await resp.body.getReader()
                    for (; ; ) {
                        let {value: chunk, done: readerDone} = await this.reader.read()
                        this.waiting = false
                        if (readerDone) {
                            break
                        }
                        const msg = JSON.parse(this.decoder.decode(chunk))
                        this.content = this.content.concat(msg.message.content)
                    }
                }
            }))
    </script>
{% endblock %}
